<html>
<head>
</head>
<body style="background: transparent;">
    <script src="scripts/docstrap.lib.js"></script>
    <script src="scripts/lunr.min.js"></script>
    <script src="scripts/fulltext-search.js"></script>

    <script type="text/x-docstrap-searchdb">
    {"app_index.js.html":{"id":"app_index.js.html","title":"Source: app/index.js","body":" Billyn Restful API Modules server/api/appserver/api/space Source: app/index.js 'use strict'; var express = require('express'); var controller = require('./app.controller'); var router = express.Router(); /** * Provides the base sever side restful api under app module * * Using Rails-like standard naming convention for endpoints. * * GET /api/apps -&gt; index * POST /api/apps -&gt; create * POST /api/apps/bulk -&gt; bulk create apps * GET /api/apps/:id -&gt; get app by id * PUT /api/apps/:id -&gt; update * DELETE /api/apps/:id -&gt; destroy * * @module server/api/app */ router.get('/', controller.index); //router.get('/byname', controller.show); router.get('/:id', controller.show); //router.get('/byname/:name', controller.getAppByName); router.post('/bulk', controller.bulkCreate); //router.post('/joinSpace', controller.joinSpace); router.post('/', controller.create); //router.post('/app', controller.createApp); router.put('/:id', controller.update); router.patch('/:id', controller.update); router.delete('/:id', controller.destroy); module.exports = router; × Search results Close "},"app_app.controller.js.html":{"id":"app_app.controller.js.html","title":"Source: app/app.controller.js","body":" Billyn Restful API Modules server/api/appserver/api/space Source: app/app.controller.js /** * Using Rails-like standard naming convention for endpoints. * GET /api/apps -&gt; index * POST /api/apps -&gt; create * GET /api/apps/:id -&gt; show * PUT /api/apps/:id -&gt; update * DELETE /api/apps/:id -&gt; destroy */ 'use strict'; import _ from 'lodash'; import {App} from '../../sqldb'; import {SpaceApp} from '../../sqldb'; import {Space} from '../../sqldb'; import {Category} from '../../sqldb'; import {Nut} from '../../sqldb'; import {PermitRole} from '../../sqldb'; var Promise = require('bluebird'); function respondWithResult(res, statusCode) { statusCode = statusCode || 200; return function (entity) { if (entity) { res.status(statusCode).json(entity); } }; } function saveUpdates(updates) { return function (entity) { return entity.updateAttributes(updates) .then(updated =&gt; { return updated; }); }; } function removeEntity(res) { return function (entity) { if (entity) { return entity.destroy() .then(() =&gt; { res.status(204).end(); }); } }; } function handleEntityNotFound(res) { return function (entity) { if (!entity) { res.status(404).end(); return null; } return entity; }; } function handleError(res, statusCode) { statusCode = statusCode || 500; return function (err) { res.status(statusCode).send(err); }; } /** * get apps according to condition, usually we use * this function to find apps under some space, in case * we need provide spaceId as params, format like: {spaceId=xxx}, * if provide userId, it will navigate to findUserApps * @method module:server/api/app.method:index * @param req.query {object} condition for finding apps * @returns {array} return array of app object, and in each app it * contain nuts under app, format like: [{_id:xxx,name:xxx, nuts: [...]}] */ export function index(req, res) { App.hasMany(Nut, { as: 'nuts' }); App.belongsTo(Category, { as: 'type' }); var spaceId = req.query.spaceId || undefined; var userId = req.query.userId || undefined; if (userId) { return findUserApps(req.res); } if (spaceId) { return App.findAll({ where: req.query, include: [ { model: Nut, as: 'nuts', where: { spaceId: spaceId } }, { model: Category, as: 'type' } ] }) .then(respondWithResult(res)) .catch(handleError(res)); } //otherwise, send error message return res.status(500).send('please check input!'); } /** * get one app. mention: if want find app by query, * please use index function to find all expected apps and then * get first one from array * @method module:server/api/app.method:show * @param req.params.id {int} if provide id param, then get by id * @returns {object} app object, contain nuts array for app */ export function show(req, res) { App.belongsTo(Category, { as: 'type' }); Nut.belongsTo(Category, { as: 'type' }); App.hasMany(Nut, { as: 'nuts' }); var appId = req.params.id || undefined; if (appId) { return App.find({ where: { _id: appId }, include: [ { model: Category, as: 'type' }, { model: Nut, as: 'nuts', include: [ { model: Category, as: 'type' } ] } ] }) .then(handleEntityNotFound(res)) .then(respondWithResult(res)) .catch(handleError(res)); } //otherwise, return error return res.status(500).send('please check input!'); } // Updates an existing App in the DB export function update(req, res) { if (req.body._id) { delete req.body._id; } App.find({ where: { _id: req.params.id } }) .then(handleEntityNotFound(res)) .then(saveUpdates(req.body)) .then(respondWithResult(res)) .catch(handleError(res)); } // Deletes a App from the DB export function destroy(req, res) { App.find({ where: { _id: req.params.id } }) .then(handleEntityNotFound(res)) .then(removeEntity(res)) .catch(handleError(res)); } export function joinSpace(req, res) { if (req.body.spaceId &amp;&amp; req.body.appId) { SpaceApp.findOrCreate({ where: req.body }) .spread(function (entity, created) { var data = { data: entity, created: created }; return Promise.resolve(data); }) .then(respondWithResult(res, 201)) .catch(handleError(res)); } } export function findAppsInSpace(req, res) { App.belongsTo(Category, { as: 'type' }); Nut.belongsTo(App, { as: 'app' }); Nut.belongsTo(Space, { as: 'space' }); Nut.belongsTo(Category, { as: 'type' }); var queryData = req.query; App.findAll({ where: queryData, include: { model: Category, as: 'type' } }) .then(function (rows) { //console.log('rows:',rows); var apps = []; return Promise.map(rows, function (row) { //console.log('row:',JSON.stringify(row)); var appId = row.appId; var spaceId = row.spaceId; var app = JSON.parse(JSON.stringify(row.app)); //console.log('app:',app); return Nut.findAll({ where: { appId: appId, spaceId: spaceId }, include: { model: Category, as: 'type' } }).then(function (rows) { app.nuts = rows; apps.push(app); }); }).then(function () { return Promise.resolve(apps); }); }) .then(respondWithResult(res, 201)) .catch(handleError(res)); } /** * create app * @method module:server/api/app.method:create * @param req.body {object} must provide spaceId, name as appName, typeId or type * @returns {object} return app object */ export function create(req, res) { //console.log('req.body:', JSON.stringify(req.body)); var spaceId = req.body.spaceId || undefined; var appName = req.body.name || undefined; var typeId = req.body.name || undefined; var type = req.body.name || undefined; if (spaceId &amp;&amp; appName &amp;&amp; (typeId || type)) { return App.add(appData, spaceId) .then(respondWithResult(res, 201)) .catch(handleError(res)); } else { return Promise.reject('Please provide spaceId &amp;&amp; name &amp;&amp; type when create app!'); } } /** * create apps in same time * @method module:server/api/app.method:bulkCreate * @param req.body {object} must provide spaceId and appDataList or appDataCollection * format like: {spaceId: xxx, appDataList(appDataCollection): []} * @returns {array} return array of app object */ export function bulkCreate(req, res) { var appDataCollection = req.body.appDataCollection || undefined; var appDataList = req.body.appDataList || undefined; var spaceId = req.body.spaceId || undefined; if (spaceId || (appDataCollection || appDataList)) { App.bulkAdd(appDataCollection, spaceId) .then(respondWithResult(res, 201)) .catch(handleError(res)); } else { res.status(500).send('please provide spaceId and appDataCollection!'); } } × Search results Close "},"space_space.controller.js.html":{"id":"space_space.controller.js.html","title":"Source: space/space.controller.js","body":" Billyn Restful API Modules server/api/appserver/api/space Source: space/space.controller.js /** * Using Rails-like standard naming convention for endpoints. * GET /api/spaces -&gt; index * POST /api/spaces -&gt; create * GET /api/spaces/:id -&gt; show * PUT /api/spaces/:id -&gt; update * DELETE /api/spaces/:id -&gt; destroy * GET /api/spaces/user/:id -&gt; findUserSpaces */ /** * Provides the base sever side restful api under space module * * Using Rails-like standard naming convention for endpoints. * * GET /api/spaces -&gt; index * POST /api/spaces -&gt; create * GET /api/spaces/:id -&gt; show * PUT /api/spaces/:id -&gt; update * DELETE /api/spaces/:id -&gt; destroy * GET /api/spaces/user/:id -&gt; findUserSpaces * POST /api/spaces/:id?userId -&gt; userJoin * * @module server/api/space */ 'use strict'; import _ from 'lodash'; import {Space} from '../../sqldb'; import {UserRole} from '../../sqldb'; import {Role} from '../../sqldb'; import {Category} from '../../sqldb'; import {SpaceApp} from '../../sqldb'; import {App} from '../../sqldb'; import {Nut} from '../../sqldb'; import {User} from '../../sqldb'; import {PermitRole} from '../../sqldb'; import {Permit} from '../../sqldb'; import Sequelize from 'sequelize'; var Promise = require('bluebird'); function respondWithResult(res, statusCode) { statusCode = statusCode || 200; return function (entity) { //console.log('response entity:', JSON.stringify(entity)); if (entity) { res.status(statusCode).json(entity); } }; } function saveUpdates(updates) { return function (entity) { return entity.updateAttributes(updates) .then(updated =&gt; { return updated; }); }; } function removeEntity(res) { return function (entity) { if (entity) { return entity.destroy() .then(() =&gt; { res.status(204).end(); }); } }; } function handleEntityNotFound(res) { return function (entity) { if (!entity) { res.status(404).end(); return null; } return entity; }; } function handleError(res, statusCode) { statusCode = statusCode || 500; return function (err) { res.status(statusCode).send(err); }; } /** * get all spaces according to condition * @method module:server/api/space.method:index * @returns {Array} array of spaces, format like: [ {_id: xxx, name: xxx, apps:[], roles:[], type:{},...},...] */ export function index(req, res) { App.belongsTo(Category, { as: 'type' }); //App.belongsTo(Space, { as: 'space' }); Space.belongsTo(Category, { as: 'type' }); Space.hasMany(App, { as: 'apps' }); Space.hasMany(Role, { as: 'roles' }); var findData = req.body; var includeData = [{ model: Category, as: 'type' //where: { _id: Sequelize.col('Spaces.typeId') } }]; if (findData.type) { Space.getType(findData.type) .then(function (type) { findData.typeId = type._id; delete findData.type; return Promise.resolve(findData); }).then(function (findData) { return Space.findAll({ where: findData, include: [ { model: Category, as: 'type' }, { model: App, as: 'apps', include: { model: Category, as: 'type' } }, { model: Role, as: 'roles', where: { fullname: { $ne: 'root.role' } } }, ] }) }) .then(respondWithResult(res)) .catch(handleError(res)); } else { Space.findAll({ where: findData, include: [ { model: Category, as: 'type' }, { model: App, as: 'apps', include: { model: Category, as: 'type' } }, { model: Role, as: 'roles', where: { fullname: { $ne: 'root.role' } } }, ] }) .then(respondWithResult(res)) .catch(handleError(res)); } } /** * get single space * @method module:server/api/space.method:show * @returns {Object} space object, format like: {_id: xxx, name: xxx, apps:[], roles:[], type:{},...} */ export function show(req, res) { console.log(req.params.id); if (req.params.id &amp;&amp; req.params.id === 'user') { return findUserSpaces(req, res); } //console.log('1'); App.belongsTo(Category, { as: 'type' }); //App.belongsTo(Space, { as: 'space' }); Space.belongsTo(Category, { as: 'type' }); Space.hasMany(App, { as: 'apps' }); Space.hasMany(Role, { as: 'roles' }); //console.log('2'); Space.find({ where: { _id: req.params.id }, include: [ { model: Category, as: 'type' }, { model: App, as: 'apps', include: { model: Category, as: 'type' } }, { model: Role, as: 'roles', where: { fullname: { $ne: 'root.role' } } }, ] }) /*.then(function(space) { //console.log('space:', JSON.stringify(space)); var oSpace = JSON.parse(JSON.stringify(space)); return Space.getType(space.typeId).then(function(type) { oSpace.type = type; return Promise.resolve(oSpace); }).then(function(oSpace) { //console.log('3 oSpace:',JSON.stringify(oSpace)); return App.findAll({ where: { spaceId: oSpace._id }, include: { model: Category, as: 'type' } }); }).then(function(sApps) { //console.log('4 apps', apps); //console.log('4 apps', JSON.stringify(sApps)); oSpace.apps = sApps; //console.log('5 oSpace', JSON.stringify(oSpace)); return Promise.resolve(oSpace); }); })*/ .then(handleEntityNotFound(res)) .then(respondWithResult(res)) .catch(handleError(res)); } /** * create a new space, this function call Space model add function to complete create of space * please see Space.add function for more information of creating space * @method module:server/api/space.method:create * @param req.body {object}, format like: {name:xxx, alias:xxx, type:{name:xxx, alias:xxx}, roles: [{...}...]} * @returns {Array} array of spaces, format like: [ {_id: xxx, name: xxx, apps:[], roles:[], type:{},...},...] */ export function create(req, res) { //console.log('space create req.body:', JSON.stringify(req.body)); var spaceData = req.body; Space.add(req.body) .then(respondWithResult(res, 201)) .catch(handleError(res)); /* var typeName; var newSpace; for (var key in spaceData) { if (key.toLowerCase() === 'type' || key.toLowerCase() === 'typename') { typeName = spaceData[key]; delete spaceData[key]; } } if (typeName) { Space.addType(typeName).then(function (type) { spaceData.typeId = type._id; Space.create(spaceData) .then(function (space) { newSpace = JSON.parse(JSON.stringify(space)); return Space.getType(space.typeId).then(function (type) { var newSpace = JSON.parse(JSON.stringify(space)); newSpace.type = type; return Promise.resolve(newSpace); }); }) .then(respondWithResult(res, 201)) .catch(handleError(res)); }) } else { Space.create(spaceData) .then(function (space) { newSpace = JSON.parse(JSON.stringify(space)); return Space.getType(space.typeId).then(function (type) { var newSpace = JSON.parse(JSON.stringify(space)); newSpace.type = type; return Promise.resolve(newSpace); }); })*/ } // Updates an existing Space in the DB export function update(req, res) { if (req.body._id) { delete req.body._id; } Space.find({ where: { _id: req.params.id } }).then(function (space) { newSpace = JSON.parse(JSON.stringify(space)); return Space.getType(space.typeId).then(function (type) { var newSpace = JSON.parse(JSON.stringify(space)); newSpace.type = type; return Promise.resolve(newSpace); }); }) .then(handleEntityNotFound(res)) .then(saveUpdates(req.body)) .then(respondWithResult(res)) .catch(handleError(res)); } // Deletes a Space from the DB export function destroy(req, res) { Space.find({ where: { _id: req.params.id } }) .then(handleEntityNotFound(res)) .then(removeEntity(res)) .catch(handleError(res)); } /** * create a new space, this function call Space model add function to complete create of space * please see Space.add function for more information of creating space * @method module:server/api/space.method:findUserSpaces * @param req.query.userId {int} userId to join * @returns {Array} array of spaces under user, format like: [ * {_id: xxx, name: xxx, roles:[], type:{}, apps: [ {_id:xxx, name: xxx, nuts: [{_id: xxx, name: xxx, permitRoles: [{ * permit: {}, nut: {}, role: {} * }]}]} ]...},...] * attention is: apps array only contain apps user can access, meanwhile roles only contain user's roles under space */ export function findUserSpaces(req, res) { //console.log('findUserSpaces req.params', JSON.stringify(req.params)); //console.log('findUserSpaces req.query', JSON.stringify(req.query)); App.belongsTo(Category, { as: 'type' }); UserRole.belongsTo(Space, { as: 'space' }); Space.belongsTo(Category, { as: 'type' }); //console.log('in findUserSpaces'); //console.log('params:', JSON.stringify(req.params)); var query = req.query; if (query) { //console.log('findUserSpaces query', JSON.stringify(query)); Space.belongsTo(Category, { as: 'type' }); //console.log(1); Space.hasMany(Role, { as: 'roles', foreignKey: 'spaceId' }); //console.log(2); Role.belongsToMany(User, { through: 'UserRole', as: 'users' }); //console.log(3); Space.hasMany(App, { as: 'apps' }); //console.log(4); App.belongsTo(Category, { as: 'type' }); //console.log(5); App.hasMany(Nut, { as: 'nuts' }); //console.log(6); Nut.hasMany(PermitRole, { foreignKey: 'ownerId', as: 'permitRoles' }); //console.log(7); PermitRole.belongsTo(Permit, { as: 'permit' }); //console.log(8); PermitRole.belongsTo(Role, { as: 'role' }); //console.log(9); return Space.findAll({ include: [ { model: Category, as: 'type' }, { model: Role, as: 'roles', include: [ { model: User, as: 'users', where: { _id: query.userId } } ] }, { model: App, as: 'apps', include: [ { model: Category, as: 'type' }, { model: Nut, as: 'nuts', include: [ { model: PermitRole, as: 'permitRoles', where: { 'owner': 'nut' }, include: [ { model: Permit, as: 'permit' }, { model: Role, as: 'role', include: [ { model: User, as: 'users', where: { _id: query.userId } } ] } ] } ] } ] } ] }).then(function (spaces) { //console.log('spaces: ', JSON.stringify(spaces)); return Promise.resolve(spaces); }) .then(respondWithResult(res)) .catch(handleError(res)); } } /** * user join to space, by default, will add user as everyone role under space * @method module:server/api/space.method:userJoin * @param req.params.id {int} space id to join * @param req.query.userId {int} userId to join * @returns {boolean} true -- created, otherwise error */ export function userJoin(req, res) { var spaceId = req.params.id; var userId = req.query.userId; // console.log(&quot;User &quot; + userId + &quot; request to join space &quot; + spaceId); Role.add({ spaceId: spaceId, name: &quot;everyone&quot; }).then(function (role) { return UserRole.findOrCreate({ userId: userId, roleId: role._id, spaceId: spaceId }); }).spread(function (created, entity) { return Promise.resolve(true); }).then(respondWithResult(res)) .catch(handleError(res)); } × Search results Close "},"modules.list.html":{"id":"modules.list.html","title":"Modules","body":" Billyn Restful API Modules server/api/appserver/api/space Modules × Search results Close "},"index.html":{"id":"index.html","title":"Index","body":" Billyn Restful API Modules server/api/appserver/api/space server apiList all restful api × Search results Close "},"module-server_api_app.html":{"id":"module-server_api_app.html","title":"Module: server/api/app","body":" Billyn Restful API Modules server/api/appserver/api/space Module: server/api/app Provides the base sever side restful api under app module Using Rails-like standard naming convention for endpoints. GET /api/apps -&gt; indexPOST /api/apps -&gt; createPOST /api/apps/bulk -&gt; bulk create appsGET /api/apps/:id -&gt; get app by idPUT /api/apps/:id -&gt; updateDELETE /api/apps/:id -&gt; destroy Source: app/index.js, line 8 Methods &lt;static&gt; method:bulkCreate() create apps in same time Parameters: Name Type Description req.body object must provide spaceId and appDataList or appDataCollectionformat like: {spaceId: xxx, appDataList(appDataCollection): []} Source: app/app.controller.js, line 274 Returns: return array of app object Type array &lt;static&gt; method:create() create app Parameters: Name Type Description req.body object must provide spaceId, name as appName, typeId or type Source: app/app.controller.js, line 248 Returns: return app object Type object &lt;static&gt; method:index() get apps according to condition, usually we usethis function to find apps under some space, in casewe need provide spaceId as params, format like: {spaceId=xxx},if provide userId, it will navigate to findUserApps Parameters: Name Type Description req.query object condition for finding apps Source: app/app.controller.js, line 67 Returns: return array of app object, and in each app itcontain nuts under app, format like: [{_id:xxx,name:xxx, nuts: [...]}] Type array &lt;static&gt; method:show() get one app. mention: if want find app by query,please use index function to find all expected apps and thenget first one from array Parameters: Name Type Description req.params.id int if provide id param, then get by id Source: app/app.controller.js, line 112 Returns: app object, contain nuts array for app Type object × Search results Close "},"module-server_api_space.html":{"id":"module-server_api_space.html","title":"Module: server/api/space","body":" Billyn Restful API Modules server/api/appserver/api/space Module: server/api/space Provides the base sever side restful api under space module Using Rails-like standard naming convention for endpoints. GET /api/spaces -&gt; indexPOST /api/spaces -&gt; createGET /api/spaces/:id -&gt; showPUT /api/spaces/:id -&gt; updateDELETE /api/spaces/:id -&gt; destroyGET /api/spaces/user/:id -&gt; findUserSpacesPOST /api/spaces/:id?userId -&gt; userJoin Source: space/space.controller.js, line 11 Methods &lt;static&gt; method:create() create a new space, this function call Space model add function to complete create of spaceplease see Space.add function for more information of creating space Parameters: Name Type Description req.body object , format like: {name:xxx, alias:xxx, type:{name:xxx, alias:xxx}, roles: [{...}...]} Source: space/space.controller.js, line 254 Returns: array of spaces, format like: [ {_id: xxx, name: xxx, apps:[], roles:[], type:{},...},...] Type Array &lt;static&gt; method:findUserSpaces() create a new space, this function call Space model add function to complete create of spaceplease see Space.add function for more information of creating space Parameters: Name Type Description req.query.userId int userId to join Source: space/space.controller.js, line 341 Returns: array of spaces under user, format like: [{_id: xxx, name: xxx, roles:[], type:{}, apps: [ {_id:xxx, name: xxx, nuts: [{_id: xxx, name: xxx, permitRoles: [{ permit: {}, nut: {}, role: {}}]}]} ]...},...]attention is: apps array only contain apps user can access, meanwhile roles only contain user's roles under space Type Array &lt;static&gt; method:index() get all spaces according to condition Source: space/space.controller.js, line 91 Returns: array of spaces, format like: [ {_id: xxx, name: xxx, apps:[], roles:[], type:{},...},...] Type Array &lt;static&gt; method:show() get single space Source: space/space.controller.js, line 175 Returns: space object, format like: {_id: xxx, name: xxx, apps:[], roles:[], type:{},...} Type Object &lt;static&gt; method:userJoin() user join to space, by default, will add user as everyone role under space Parameters: Name Type Description req.params.id int space id to join req.query.userId int userId to join Source: space/space.controller.js, line 447 Returns: true -- created, otherwise error Type boolean × Search results Close "}}
    </script>

    <script type="text/javascript">
        $(document).ready(function() {
            Searcher.init();
        });

        $(window).on("message", function(msg) {
            var msgData = msg.originalEvent.data;

            if (msgData.msgid != "docstrap.quicksearch.start") {
                return;
            }

            var results = Searcher.search(msgData.searchTerms);

            window.parent.postMessage({"results": results, "msgid": "docstrap.quicksearch.done"}, "*");
        });
    </script>
</body>
</html>
